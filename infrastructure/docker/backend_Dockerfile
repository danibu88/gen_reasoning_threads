# Use Python 3.9.6 as the base image
FROM python:3.9.6-slim

# Set the working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential cmake gcc g++ gfortran \
    libatlas-base-dev libhdf5-dev libssl-dev libffi-dev \
    libblas-dev liblapack-dev libopenblas-dev \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Copy only requirements first
COPY ../../src/backend/FlaskBackend/git-lfs-3.5.1/requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade --force-reinstall -r requirements.txt

# Copy full project
COPY ../../src/backend/FlaskBackend/git-lfs-3.5.1 .

# Download NLP models
RUN python -c "import benepar; benepar.download('benepar_en3')" && \
    python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords'); nltk.download('averaged_perceptron_tagger')"

# Ensure models & data directory
RUN mkdir -p /opt/findyoursolution/models && chmod 755 /opt/findyoursolution/models
RUN mkdir -p /opt/findyoursolution/data && chmod 755 /opt/findyoursolution/data

# Copy entrypoint and set permission
COPY ../../src/backend/FlaskBackend/git-lfs-3.5.1/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Create symlinks
RUN ln -sf /root/opt/findyoursolution/models/word2vec.model /app/word2vec.model
RUN ln -sf /root/opt/findyoursolution/models/top2vecmodel.model /app/top2vecmodel.model
RUN ln -sf /root/opt/findyoursolution/models/triples_ontology.model /app/triples_ontology.model
RUN ln -sf /root/opt/findyoursolution/models/triples12122022.csv /app/triples12122022.csv
RUN ln -sf /root/opt/findyoursolution/data/triples_generated.csv /app/triples_generated.csv

# Expose port
EXPOSE 3002

# Default command
CMD ["/app/entrypoint.sh"]
